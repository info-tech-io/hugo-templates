# Federation Deployment Guide

**Part of Child Issue #19 - Download-Merge-Deploy Logic**
**Stage 3: Deploy Preparation**

## Overview

This guide provides step-by-step instructions for deploying your federated Hugo site to GitHub Pages after successfully running the federated build system.

## Prerequisites

Before deploying, ensure you have:

1. ✅ Completed a successful federation build with `scripts/federated-build.sh`
2. ✅ Deployment artifacts generated in `public/.federation/`
3. ✅ Deployment readiness verified (the build script checks this automatically)
4. ✅ Access to your GitHub Pages repository
5. ✅ Git installed and configured

## Deployment Workflow

### Phase 1: Pre-Deployment Verification

#### 1.1 Review Build Output

Check the build summary at the end of the federation build:

```
╔══════════════════════════════════════════════════════════════╗
║                  Federation Build Report                     ║
╚══════════════════════════════════════════════════════════════╝

Federation: Your Federation Name
Modules:    3

✅ Successful: 3
```

**Action**: Verify all modules built successfully. If any failed, review error messages and fix before deploying.

#### 1.2 Review Deployment Readiness Checks

The build automatically runs 5 deployment checks:

1. ✅ Output directory validation (exists and has content)
2. ✅ Federation manifest validation (valid JSON)
3. ✅ Build success validation (at least one successful build)
4. ✅ Deployment artifacts validation (checksums, metadata present)
5. ✅ Root index file check (index.html exists)

**Action**: If any checks failed, the build will exit with an error. Address the issues before proceeding.

#### 1.3 Verify Checksums

Validate file integrity using the generated checksums:

```bash
cd public
sha256sum -c .federation/checksums.sha256
```

**Expected output**: All files should show "OK" status.

**Action**: If any files show checksum mismatches, re-run the build.

#### 1.4 Review Deployment Manifest

Inspect the enhanced manifest for deployment metadata:

```bash
cat public/.federation/federation-manifest.json
```

Key fields to verify:
- `deployment.ready`: Should be `true`
- `deployment.validated`: Should be `true`
- `federation.successfulBuilds`: Should equal `totalModules`
- `federation.buildDurationSeconds`: Build time in seconds

**Action**: Ensure `deployment.ready` is `true` before proceeding.

### Phase 2: GitHub Pages Deployment

#### 2.1 Option A: Deploy to `gh-pages` Branch (Recommended)

This is the most common approach for project sites.

**Step 1**: Ensure you have a clean gh-pages branch:

```bash
# Check if gh-pages branch exists
git branch -a | grep gh-pages

# If it doesn't exist, create it
git checkout --orphan gh-pages
git rm -rf .
```

**Step 2**: Copy federation output to gh-pages branch:

```bash
# From your project root
git checkout gh-pages

# Remove old content (keep .git directory)
find . -maxdepth 1 ! -name '.git' ! -name '.' ! -name '..' -exec rm -rf {} +

# Copy new federation output
cp -r public/* .
cp -r public/.federation .

# Stage all changes
git add .
```

**Step 3**: Commit and push:

```bash
# Create deployment commit with metadata
git commit -m "Deploy federation build - $(date -u +'%Y-%m-%d %H:%M:%S UTC')

- Federation: $(jq -r '.federation.name' .federation/federation-manifest.json)
- Modules: $(jq -r '.federation.totalModules' .federation/federation-manifest.json)
- Successful builds: $(jq -r '.federation.successfulBuilds' .federation/federation-manifest.json)
- Build duration: $(jq -r '.federation.buildDurationSeconds' .federation/federation-manifest.json)s
- Total size: $(jq -r '.deployment.totalSize' .federation/federation-manifest.json)

Generated by Hugo Template Factory - Federated Build System
Manifest: .federation/federation-manifest.json"

# Push to GitHub
git push origin gh-pages --force
```

**Note**: Using `--force` is safe here because gh-pages is a deployment branch with no development history to preserve. However, if your team uses gh-pages differently, use `git push origin gh-pages` instead.

#### 2.2 Option B: Deploy to `main` Branch (User/Organization Site)

For user or organization sites (`username.github.io`):

```bash
# Ensure you're on main branch
git checkout main

# Clear existing content (except .git and build system)
find . -maxdepth 1 ! -name '.git' ! -name 'scripts' ! -name 'docs' ! -name 'tests' ! -name '.' ! -name '..' -exec rm -rf {} +

# Copy federation output to root
cp -r public/* .
cp -r public/.federation .

# Stage and commit
git add .
git commit -m "Deploy federation $(date -u +'%Y-%m-%d')"

# Push
git push origin main
```

#### 2.3 Option C: Deploy via GitHub Actions

Create `.github/workflows/deploy.yml`:

```yaml
name: Deploy Federation to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      - name: Build Federation
        run: bash scripts/federated-build.sh --config=modules.json

      - name: Verify Deployment
        run: |
          cd public
          sha256sum -c .federation/checksums.sha256
          test -f .federation/federation-manifest.json

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          commit_message: "Deploy federation ${{ github.sha }}"
```

### Phase 3: Post-Deployment Verification

#### 3.1 Verify Deployment

Wait 1-2 minutes for GitHub Pages to build, then verify your deployment:

**Check the live site**:
```
https://<username>.github.io/<repository>/
```

or for user/organization sites:
```
https://<username>.github.io/
```

#### 3.2 Verify Module Accessibility

Test each module's destination:

```bash
# Example for modules at /docs/, /quiz/, /blog/
curl -I https://your-site.github.io/docs/
curl -I https://your-site.github.io/quiz/
curl -I https://your-site.github.io/blog/
```

**Expected**: All should return `200 OK` status.

#### 3.3 Verify Federation Manifest

Check that the manifest is accessible:

```bash
curl https://your-site.github.io/.federation/federation-manifest.json | jq .
```

**Expected**: Should return valid JSON with deployment metadata.

#### 3.4 Test CSS Path Resolution

Inspect a few pages from subdirectory-deployed modules:

1. Open `https://your-site.github.io/<module-destination>/`
2. Open browser DevTools → Network tab
3. Refresh the page
4. Verify all CSS/JS assets load successfully (no 404 errors)
5. Check that asset paths include the module's destination prefix

**Example**: For a module deployed to `/quiz/`, CSS links should be `/quiz/css/style.css`, not `/css/style.css`.

### Phase 4: Rollback Procedures

If issues are discovered after deployment:

#### 4.1 Quick Rollback (gh-pages branch)

```bash
# Switch to gh-pages branch
git checkout gh-pages

# View commit history
git log --oneline -10

# Identify the last good deployment commit
# Rollback to that commit
git reset --hard <commit-hash>

# Force push to restore previous version
git push origin gh-pages --force

# Switch back to main
git checkout main
```

#### 4.2 Rollback via GitHub Interface

1. Go to your repository on GitHub
2. Navigate to the `gh-pages` branch
3. Click "Commits" to view history
4. Find the last good deployment
5. Click the `<>` button next to that commit to browse files at that point
6. Click "…" → "View commit details"
7. Click "Revert" to create a revert commit

#### 4.3 Rollback with Backup

If you maintain deployment backups:

```bash
# Restore from backup
git checkout gh-pages
rm -rf *
cp -r /path/to/backup/* .
git add .
git commit -m "Rollback to backup from $(date)"
git push origin gh-pages
```

## Troubleshooting

### Issue: 404 on Module Pages

**Symptom**: Main site loads but module pages return 404.

**Diagnosis**:
```bash
# Check if files exist in gh-pages
git checkout gh-pages
ls -la <module-destination>/
```

**Solution**:
1. Verify module destination in `modules.json`
2. Check build logs for merge errors
3. Re-run build with `--verbose` flag
4. Redeploy after fixing configuration

### Issue: CSS/JS Not Loading

**Symptom**: Pages load but have no styling or broken images.

**Diagnosis**:
```bash
# Check asset paths in HTML
grep -n 'href="/css' public/<module-destination>/index.html
grep -n 'src="/js' public/<module-destination>/index.html
```

**Solution**:
1. Verify CSS path rewriting ran successfully (check build logs for "CSS path resolution complete")
2. Ensure module has correct `destination` in `modules.json`
3. Check for double slashes in paths (build validates this automatically)
4. Re-run build and redeploy

### Issue: Checksum Validation Fails

**Symptom**: `sha256sum -c` reports mismatches.

**Diagnosis**:
```bash
# Re-generate checksums locally
cd public
find . -type f ! -path "./.federation/*" -exec sha256sum {} \; > /tmp/new-checksums.txt
diff /tmp/new-checksums.txt .federation/checksums.sha256
```

**Solution**:
1. Re-run the federation build completely
2. Do not manually edit files in `public/` directory
3. Ensure no background processes are modifying files during build

### Issue: Deployment Readiness Check Fails

**Symptom**: Build exits with "Deployment readiness verification failed".

**Diagnosis**: Review the 5 checks in build output:

```
Check 1/5: Output Directory
Check 2/5: Federation Manifest
Check 3/5: Build Success
Check 4/5: Deployment Artifacts
Check 5/5: Root Index File
```

**Solution**:
1. Fix the specific failing check(s)
2. Re-run the build
3. Verify all checks pass before deploying

## Best Practices

### 1. Version Control

- Always commit `modules.json` changes before building
- Tag deployment commits for easy rollback:
  ```bash
  git tag -a deploy-$(date +%Y%m%d-%H%M) -m "Deployment $(date)"
  git push origin --tags
  ```

### 2. Incremental Updates

When using `--preserve-base-site`:

1. Ensure `federation.baseURL` is set correctly in `modules.json`
2. Test the download phase first:
   ```bash
   bash scripts/federated-build.sh --preserve-base-site --verbose
   ```
3. Review merge strategy for each module (use `preserve` to keep existing content when possible)

### 3. Monitoring

After deployment, monitor:

- GitHub Pages build status (check repository Settings → Pages)
- Site analytics for 404 errors
- Browser console for asset loading errors
- Manifest file for accurate metadata

### 4. Documentation

Keep deployment history:

```bash
# Create deployment log
echo "$(date -u): Deployed federation with $SUCCESSFUL_BUILDS modules" >> docs/deployment-log.txt
git add docs/deployment-log.txt
git commit -m "Update deployment log"
```

## Advanced Topics

### Custom Domains

If using a custom domain with GitHub Pages:

1. Add `CNAME` file to your repository root:
   ```bash
   echo "your-domain.com" > public/CNAME
   git add public/CNAME
   ```

2. Update `federation.baseURL` in `modules.json`:
   ```json
   "federation": {
     "baseURL": "https://your-domain.com"
   }
   ```

3. Configure DNS as per [GitHub's custom domain guide](https://docs.github.com/en/pages/configuring-a-custom-domain-for-your-github-pages-site)

### Automated Deployments

Set up automated deployments for module updates:

1. Create a webhook in each module repository
2. Trigger federation build on module updates
3. Use GitHub Actions to automatically deploy after successful build

See `.github/workflows/deploy.yml` example above.

### Performance Optimization

For large federations:

1. Enable aggressive caching for static assets
2. Use CDN for `.federation/` artifacts
3. Implement lazy loading for module-specific content
4. Monitor `deployment.totalSize` in manifest to track growth

## Support

For issues or questions:

1. Check build logs in verbose mode: `--verbose`
2. Review deployment artifacts in `public/.federation/`
3. Consult the [modules.json reference](./modules-json-reference.md)
4. Report issues on GitHub

---

**Last Updated**: 2025-10-17
**Part of**: Epic #15 - Federated Build System
**Child Issue**: #19 - Download-Merge-Deploy Logic
